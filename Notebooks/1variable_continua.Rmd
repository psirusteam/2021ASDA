---
title: "Variable continua"
author: "CEPAL"
date: "14/2/2022"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, error = FALSE)
options(digits = 4)
library (survey)
library(srvyr)
library(convey)
library(TeachingSampling)
library(printr)
```

## Lectura de la base

```{r}
encuesta <- readRDS("../Data/encuesta.rds")
```

## Definir diseño de la muestra con `srvyr`

```{r}
library(srvyr)

diseno <- encuesta %>%
  as_survey_design(
    strata = Stratum,
    ids = PSU,
    weights = wk,
    nest = T
  )

```

## Histograma ponderado para la variable ingreso

```{r, hist1, eval = FALSE}
svyhist(
  ~ Income ,
  diseno,
  main = "",
  col = "grey80",
  xlab = "Histograma del ingreso"
)

```

## Histograma ponderado para la variable ingreso

```{r, hist1, echo = FALSE, eval = TRUE}
```

## Comparación de histogramas

```{r, hist2, eval=FALSE}
data("BigCity", package = "TeachingSampling")
par(mfrow = c(1,3))
svyhist(   ~ Income,
  diseno, main = "Ponderado",
  col = "green"
)
hist( encuesta$Income,
  main = "Sin ponderar",
  col = "red", prob = TRUE
)
hist(  BigCity$Income,
  main = "Poblacional",
  col = "purple", prob = TRUE,
  xlim = c(0, 2500), breaks = 200
)


```

## Comparación de histogramas

```{r, hist2, echo = FALSE, eval = TRUE}
```

## Sub-grupos

Extraer sub-grupos de la encuesta.

```{r}
sub_Urbano <- diseno %>%  filter(Zone == "Urban")
sub_Rural  <- diseno %>%  filter(Zone == "Rural")
sub_Mujer  <- diseno %>%  filter(Sex == "Female")
sub_Hombre <- diseno %>%  filter(Sex == "Male")
```

## Histograma ponderado en sub-grupos

```{r, hist3, eval=FALSE}
par(mfrow = c(1,2))
svyhist(
  ~ Income ,
  subset (sub_Mujer, Age >= 18),
  main = "",
  col = "grey80",
  xlab = "Histograma del ingreso"
)

svyhist(
  ~ Income ,
  subset (sub_Urbano, Age >= 18),
  main = "",
  col = "grey80",
  xlab = "Histograma del ingreso"
)

```

## Histograma ponderado en sub-grupos

```{r, hist3, echo = FALSE, eval = TRUE}
```

## Boxplot ponderado del ingreso por sub-grupos

```{r,box1, echo = TRUE, eval = FALSE}
par(mfrow = c(1,2))
svyboxplot(
  Income ~1 ,
  sub_Urbano,
  col = "grey80",
  ylab = "Ingreso",
  xlab = "Urbano")

svyboxplot(
  Income ~ 1 ,
  sub_Rural,
  col = "grey80",
  ylab = "Ingreso",
  xlab = "Rural"
)
```

## Boxplot ponderado del ingreso por sub-grupos

```{r,box1, echo = FALSE, eval = TRUE}
```

## Boxplot ponderado del ingreso por sub-grupos alternativa

```{r, box2, eval = FALSE, echo=TRUE}
library(ggplot2)
ggplot(data = encuesta, 
       aes(y = Income, x = Zone, weight = wk)) +
  geom_boxplot() + ylim(c(0, 1000))

```

## Boxplot ponderado del ingreso por sub-grupos alternativa

```{r, box2, eval = TRUE, echo = FALSE}
```

## Estimación de totales e intervalos de confianza del ingreso

```{r}
svytotal (~Income, diseno, deff=T) %>%
  data.frame()
confint(svytotal (~Income, diseno, deff=T))

```

## Estimación de totales e intervalos de confianza del gasto

```{r}
svytotal (~Expenditure, diseno, deff=T) %>% 
  data.frame()
confint(svytotal (~Expenditure, diseno, deff=T))

```

## Estimación de totales por sub-grupos

```{r}
diseno %>% group_by(Sex) %>%
  cascade(
    Total = survey_total(Income, level = 0.95,
                         vartype =  c("se", "ci") ), 
  .fill = "Total ingreso")


```

## Estimación de la media e intervalo de confianza del ingreso

```{r}

svymean(~Income, diseno, deff=T) %>% 
  data.frame()
confint(svymean (~Income, diseno, deff=T))

```

## Estimación de la media e intervalo de confianza del gasto

```{r}
svymean (~Expenditure, diseno, deff=T) %>% 
  data.frame()
confint(svymean (~Expenditure, diseno, deff=T))

```

## Estimación de la media por sub-grupos

```{r}
diseno %>% group_by(Sex) %>%
  cascade(Media = survey_mean(Expenditure, level = 0.95,
                         vartype =  c("se", "ci")), 
          .fill = "El gasto medio"  ) %>% arrange(desc(Sex))
diseno %>% group_by(Zone) %>%
  cascade(Media = survey_mean(Expenditure, level = 0.95,
                         vartype =  c("se", "ci")), 
          .fill = "El gasto medio")%>% arrange(desc(Zone))


```

## Estimación de medias por sub-grupos

```{r}
diseno %>% group_by(Zone, Sex) %>%
  cascade( 
    Media = survey_mean(Expenditure, level = 0.95,
                         vartype =  c("se", "ci")), 
    .fill = "El gasto medio") %>%
  arrange(desc(Zone), desc(Sex)) %>% 
  data.frame()

```


## Estimación de la desviación estándar de los ingresos por sub-grupo

```{r}
(tab_sd <- diseno %>% group_by(Zone) %>% 
   summarise(Sd = sqrt(
  survey_var(
    Income,
    level = 0.95,
    vartype =  c("se", "ci"),
  )
)))

```

## Estimación de la desviación estándar de los ingresos por sub-grupo

```{r}
(tab_sd <- diseno %>% group_by(Zone, Sex) %>% 
   summarise(Sd = sqrt(
  survey_var(
    Income,
    level = 0.95,
    vartype =  c("se", "ci"),
   )
))) %>% data.frame()

```

## Estimación de la mediana para gastos

```{r}
diseno %>% summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación de la mediana por sub-grupo

```{r}
diseno %>% group_by(Zone) %>% 
  summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación de la mediana por sub-grupo

```{r}
diseno %>% group_by(Sex) %>% 
  summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación de quantile para el gasto

```{r}
diseno %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.5,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación de quantile para el gasto por sub-grupo

```{r}
diseno %>% group_by(Sex) %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.25,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación de quantile para el gasto por sub-grupo

```{r}
diseno %>% group_by(Zone) %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.25,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación de la razón entre el gasto y el ingreso

```{r}
diseno %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón entre hombres y mujeres

```{r}
diseno %>% summarise(
    Razon =  survey_ratio(
      numerator = (Sex == "Female"),
      denominator = (Sex == "Male"),
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón entre hombres y mujeres en la zona rural

```{r}
sub_Rural %>% summarise(
    Razon =  survey_ratio(
      numerator = (Sex == "Female"),
      denominator = (Sex == "Male"),
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón del gastos y los ingreso entre las mujeres

```{r}
sub_Mujer %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón del gasto y los ingresos entre los hombres

```{r}
sub_Hombre %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación del índice de GINI

La estimación del índice de GINI se realiza haciendo uso de la librería `convey`

```{r}
library(convey)
diseno_gini <- convey_prep(diseno)
svygini( ~Income, design = diseno_gini) %>%
  data.frame()

svygini( ~Expenditure, design = diseno_gini) %>%
  data.frame()

```

## Estimación del índice de GINI por sub-grupo

```{r}
svylorenz( ~Income, diseno_gini, 
           seq(0,1,.05), alpha = .01 )

```

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres

```{r}
svyttest(Income ~ Sex, diseno)

```

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres en la zona urbana

```{r}
svyttest(Income ~ Sex, sub_Urbano)

```

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres mayores a 18 años

```{r}
svyttest(Income ~ Sex, diseno %>% filter(Age > 18))

```

## Contrastes 

```{r}
(prom_region <- svyby(~Income, ~Region, diseno, 
                      svymean, na.rm=T, covmat = TRUE,
                      vartype = c("se", "ci")))

# Paso 1: diferencia de estimaciones (Norte - Sur) 
527 - 627 


```
## contrastes
```{r}
# Paso 2: error estándar de la diferencia
vcov(prom_region)

sqrt(1909 + 2856 - 2*0)

```


## contrastes
```{r}
svycontrast(prom_region,
            list(diff_NS = c(1, -1, 0, 0, 0))) %>%
  data.frame()

```


## Contrastes 

```{r}

svycontrast(prom_region, list(
              Norte_sur = c(1, 1, 0, 0, 0),
              centro = c(0, 0, 1, 0, 0),
              Occidente_Oriente = c(0, 0, 0, 1, 1)
            )) %>% data.frame()

sqrt(1909 + 2856 - 2*0) ; sqrt(6867);
sqrt(2817 + 1069 - 2*0)

```


## Contrastes no independiente

```{r}
(prom_sexo <- svyby(~Income, ~Sex, diseno,
                   svymean, na.rm=T,covmat = TRUE,
                   vartype = c("se", "ci")))


```

## Contrastes no independiente
```{r}
svycontrast(prom_sexo, list(diff_Sexo = c(1, -1))) %>% 
  data.frame()
```


## Contrastes no independiente

```{r}
vcov(prom_sexo)
# Note que el error estandar  de la diferencia es igual a 
sqrt(582 + 733 - 2*449)
```


## Contrastes no independiente

```{r}
(sum_region <- svyby( ~ Income,  ~ Region,
                     diseno, svytotal, na.rm = T,
                     covmat = TRUE,
                     vartype = c("se", "ci")))

```

## Contrastes no independiente

```{r}
svycontrast(sum_region,
            list(
              Agregado_NCS = c(1, 1, 1, 0, 0)
              )) %>% data.frame()

# Note que el error estandar  de la diferencia es igual a 
sqrt(582 + 733 - 2*449)
```

## Contrastes

```{r}
vcov(sum_region)

sqrt(2805154074898 + 3839259031856 + 7559032807016 )

```

## Contrastes no independiente

```{r}
(prom_edad <- svyby(~Income, ~CatAge, diseno, svymean, na.rm=T,covmat = TRUE))

svycontrast(prom_edad,
            list(
              agregado_edad = c(1/6, 1/6, 1/6, 1/6, 1/6, 1/6)
              )) %>% data.frame()

```

## Contrastes no independiente

```{r}
vcov(prom_edad)
(1/6)*sqrt(4888 + 646 + 1611 + 2197 + 1181 + 5553 
       + 2*22 + 2*(-1289) + 2*864 + 2*(-1387) + 2*189 +
       2*454 + 2*441 + 2*347 + 2*856 +
       2*290 + 2*820 + 2*1337+ 
       2*103 + 2*488 + 
       2*268)
```

## Contrastes no independiente

```{r}

(razon_sexo <- svyby(~Income, ~Sex, denominator = ~Expenditure,
                     diseno, svyratio, na.rm=T, covmat = TRUE, vartype = c("se", "ci")))

svycontrast(razon_sexo,
            list(
              diff_sexo = c(1, -1)
              )) %>% data.frame()

```


## Contrastes no independiente

```{r}

vcov(razon_sexo)
sqrt(0.0034 + 0.0024 - 2*0.0022)

```
