---
title: "Variable categórica"
author: "CEPAL"
date: "17/2/2022"
output: beamer_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, error = FALSE)
options(digits = 4)
library (survey)
library(srvyr)
library(convey)
library(TeachingSampling)
library(printr)
```

## Lectura de la base

```{r}
encuesta <- readRDS("../Data/encuesta.rds")
```

## Definir diseño de la muestra con `srvyr`

```{r}
library(srvyr)

diseno <- encuesta %>%
  as_survey_design(
    strata = Stratum,
    ids = PSU,
    weights = wk,
    nest = T
  )

```

## definir nuevas variables
```{r, tabs1, echo=TRUE, eval=TRUE}
diseno <- diseno %>% mutate(
  pobreza = ifelse(Poverty != "NotPoor", 1, 0),
  desempleo = ifelse(Employment == "Unemployed", 1, 0),
  edad_18 = case_when(Age < 18 ~ "< 18 años",
                      TRUE ~ ">= 18 años")
)
```


## Sub-grupos

Extraer sub-grupos de la encuesta.

```{r}
sub_Urbano <- diseno %>%  filter(Zone == "Urban")
sub_Rural  <- diseno %>%  filter(Zone == "Rural")
sub_Mujer  <- diseno %>%  filter(Sex == "Female")
sub_Hombre <- diseno %>%  filter(Sex == "Male")
```


## Estimación de tamaño  

```{r}
(tamano_zona <- diseno %>% group_by(Zone) %>% 
   summarise(
     n = unweighted(n()),
     Nd = survey_total(vartype = c("se","ci"))))

```

## Estimación de tamaño  

```{r}
(tamano_pobreza <- diseno %>% group_by(Poverty) %>% 
   summarise(
       Nd = survey_total(vartype = c("se","ci"))))

```

## Estimación de tamaño  

```{r}
(tamano_pobreza <- diseno %>% 
   group_by(pobreza) %>% 
   summarise(
       Nd = survey_total(vartype = c("se","ci"))))

```

## Estimación de tamaño  

```{r}
(tamano_ocupacion <- diseno %>% 
   group_by(Employment) %>% 
   summarise(
       Nd = survey_total(vartype = c("se","ci"))))

```

## Estimación de tamaño  

```{r tabs0, echo=TRUE, eval=FALSE}
(tamano_ocupacion_pobreza <- diseno %>% 
   group_by(Employment, Poverty) %>% 
   cascade(
       Nd = survey_total(vartype = c("se","ci")), 
       .fill = "Total") %>% 
   data.frame()
   )

```

## Estimación de tamaño 

```{r tabs0, echo=FALSE, eval=TRUE}
```


## Estimación de proporción de urbano y rural 

```{r}
(prop_zona <- diseno %>% group_by(Zone) %>% 
   summarise(
     prop = survey_mean(vartype = c("se","ci"), 
                        proportion = TRUE )))

(prop_zona2 <- diseno %>% group_by(Zone) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci") )))


```

## Poporsión de hombres y mujeres en la zona urbana y rural

```{r}
(prop_sexoU <- sub_Urbano %>% group_by(Sex) %>% 
   summarise(
     n = unweighted(n()),
     prop = survey_prop(vartype = c("se","ci"))))

(prop_sexoR <- sub_Rural %>% group_by(Sex) %>% 
   summarise(
     n = unweighted(n()),
     prop = survey_prop(vartype = c("se","ci"))))

```

## Poporsión de hombres en la zona urbana y rural

```{r}
(prop_ZonaH <- sub_Hombre %>% group_by(Zone) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci"))))

```

## Poporsión de mujeres en la zona urbana y rural

```{r}
(prop_ZonaM <- sub_Mujer %>% group_by(Zone) %>% 
   summarise(
    prop = survey_prop(vartype = c("se","ci"))))

```

## Poporsión de hombres en la zona urbana y rural

```{r}
(prop_ZonaH_Pobreza <- sub_Hombre %>%
   group_by(Zone, Poverty) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci")))%>%
   data.frame())

```

## Poporsión de mujeres en la zona urbana y rural

```{r}
(prop_ZonaM_Pobreza <- sub_Mujer %>% 
   group_by(Zone, Poverty) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci"))) %>%
   data.frame())

```

## Poporsión de hombres en la zona y empleado

```{r}
(prop_ZonaH_Ocupacion <- sub_Hombre %>%
   group_by(Zone, Employment) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci")))%>%
   data.frame())

```

## Poporsión de mujeres en la zona urbana y rural

```{r}
(prop_ZonaM_Ocupacion <- sub_Mujer %>% 
   group_by(Zone, Employment) %>% 
   summarise(
     prop = survey_prop(vartype = c("se","ci"))) %>%
   data.frame())

```



## Estimación de la proporción de personas menor a 18 años
```{r, tabs01, echo=TRUE, eval=FALSE}
diseno %>% 
group_by(edad_18, pobreza) %>% 
  summarise(
    Prop = survey_prop(vartype =  c("se", "ci"))) %>%
  data.frame()
```

## Estimación de la proporción de personas menor a 18 años
```{r, tabs01, echo=FALSE, eval=TRUE}
```

## Estimación de la proporción de personas menor a 18 años
```{r, tabs2, echo=TRUE, eval=FALSE}
diseno %>% 
  group_by(edad_18, desempleo) %>% 
  summarise(
    Prop = survey_prop(vartype =  c("se", "ci"))) %>%
  data.frame()
```

## Estimación de la proporción de personas menor a 18 años
```{r, tabs2, echo=FALSE, eval=TRUE}
```


## Estimación de la proporción de personas menor a 18 años en zona rural

```{r}
sub_Rural %>%
  group_by(edad_18) %>% 
  summarise(
    Prop = survey_prop(vartype =  c("se", "ci"))) %>%
  data.frame()
```

## Estimación de la proporción de mujeres rango de edad

```{r}
sub_Mujer %>% mutate(edad_rango = case_when(
  Age>= 18 & Age <=35  ~ "18 - 35",
  TRUE ~ "Otro")) %>%
  group_by(edad_rango, Employment) %>% 
  summarise(
    Prop = survey_prop(vartype =  c("se", "ci"))) %>%
  data.frame()
```


## Estimación de la proporción de hombres rango de edad

```{r}
sub_Hombre %>% mutate(edad_rango = case_when(
  Age>= 18 & Age <=35  ~ "18 - 35",
  TRUE ~ "Otro")) %>%
  group_by(edad_rango, Employment) %>% 
  summarise(
    Prop = survey_prop(vartype =  c("se", "ci"))) %>%
  data.frame()
```

## Tabla Zona Vs Sexo

```{r, tab2, eval=FALSE}
(
  prop_sexo_zona <- diseno %>% 
    group_by(Sex, Zone, pobreza) %>%
    summarise(
      prop = survey_prop(vartype = c("se", "ci"))) %>% 
    data.frame()
)

```

## Tabla Zona Vs Sexo

```{r, tab2, echo = FALSE, eval = TRUE}
```

## Tablas de doble entrada. 

```{r}
tab_Sex_Pobr <- svyby(~Sex,  ~pobreza, diseno, svymean)
tab_Sex_Pobr %>% select(-se.SexFemale, -se.SexMale)
tab_Sex_Pobr %>% select(-SexFemale, -SexMale)
```

## Tablas de doble entrada. 

```{r}
confint(tab_Sex_Pobr) %>% as.data.frame()
```

## Prueba de independencia. 

```{r}
svychisq(~Sex + pobreza, diseno, statistic="F")
```

## Tablas de doble entrada. 

```{r}
tab_Sex_Ocupa <- svyby(~Sex,  ~Employment, diseno, svymean)
tab_Sex_Ocupa %>% select(-se.SexFemale, -se.SexMale)
tab_Sex_Ocupa %>% select(-SexFemale, -SexMale)
```
## Tablas de doble entrada 
```{r}
confint(tab_Sex_Ocupa) %>% as.data.frame()
```


## Prueba de independencia. 

```{r}
svychisq(~Sex + Employment, 
         design = diseno,  statistic="F")
```


## Tablas de doble entrada. 

```{r}
tab_region_pobreza <- 
  svyby(~as.factor(pobreza),  ~Region, diseno, svymean)
tab_region_pobreza %>% 
  select(-"se.as.factor(pobreza)0",
         -"se.as.factor(pobreza)1")

```

## Tablas de doble entrada.
```{r}
tab_region_pobreza %>% 
 select("se.as.factor(pobreza)0",
        "se.as.factor(pobreza)1")
```


## Prueba de independencia. 

```{r}
svychisq(~Region + pobreza, 
         design = diseno,  statistic="F")
```

## Razón de obbs

```{r, echo = TRUE, eval = TRUE}
(tab_Sex <- svyby(~pobreza,  ~Sex, diseno,
                 svymean, vartype = c("se", "ci")))
svycontrast(tab_Sex, quote(`Female`/`Male`)  )
```

## Razón de obbs

```{r, echo = TRUE, eval = TRUE}
tab_Sex_Pobr <- 
   svymean(~interaction (Sex, pobreza), diseno, 
             se=T, na.rm=T, ci=T, keep.vars=T) 
  tab_Sex_Pobr %>%  as.data.frame()

```

## Razón de obbs
\footnotesize
```{r, echo = TRUE, eval = TRUE}
svycontrast(tab_Sex_Pobr, 
            quote((`interaction(Sex, pobreza)Female.0`/
                     `interaction(Sex, pobreza)Female.1`)/
                  (`interaction(Sex, pobreza)Male.0`/
                     `interaction(Sex, pobreza)Male.1`) ))
```

## Razón de obbs

$$
 \frac{\frac{P(Sex = Male \mid pobreza = 1 )}{P(Sex = Female \mid pobreza = 1 )}}{
 \frac{P(Sex = Male \mid pobreza = 0 )}{P(Sex = Female \mid pobreza = 0 )}
 }
$$
\footnotesize
```{r, echo = TRUE, eval = TRUE}
svycontrast(tab_Sex_Pobr, 
            quote((`interaction(Sex, pobreza)Male.1`/
                     `interaction(Sex, pobreza)Female.1`)/
                  (`interaction(Sex, pobreza)Male.0`/
                   `interaction(Sex, pobreza)Female.0`)))

```


## Contrastes 

```{r}
(tab_sex_pobreza <- svyby(~pobreza, ~Sex, 
                          diseno , 
                      svymean, na.rm=T, covmat = TRUE,
                      vartype = c("se", "ci")))

# Paso 1: diferencia de estimaciones 
0.3937		 - 0.4047		 


```
## contrastes
```{r}
# Paso 2: error estándar de la diferencia
vcov(tab_sex_pobreza)

sqrt(0.0009227 + 0.0007294 - 2*0.0006551)

```


## contrastes
```{r}
svycontrast(tab_sex_pobreza,
            list(diff_Sex = c(1, -1))) %>%
  data.frame()

```


## Contrastes 

```{r}
(tab_sex_desempleo <- svyby(~desempleo, ~Sex, 
                          diseno %>% filter(!is.na(desempleo)) , 
                      svymean, na.rm=T, covmat = TRUE,
                      vartype = c("se", "ci")))
# diferencia de estimaciones 
0.07237 - 0.02854	

```

## Contrastes 
```{r}
vcov(tab_sex_desempleo)

sqrt(0.000037026 + 0.00015547 - 2*0.000013369)
svycontrast(tab_sex_desempleo,
            list(diff_Sex = c(-1, 1))) %>%
  data.frame()

```


## Contrastes 

```{r}
(tab_region_desempleo <- svyby(~desempleo, ~Region, 
                          diseno %>% filter(!is.na(desempleo)) , 
                      svymean, na.rm=T, covmat = TRUE,
                      vartype = c("se", "ci")))

```


```{r}
vcov(tab_region_desempleo)
```

## Contrastes 

```{r}
(tab_region_pobreza <- svyby(~pobreza, ~Region, 
                          diseno %>% filter(!is.na(desempleo)) , 
                      svymean, na.rm=T, covmat = TRUE,
                      vartype = c("se", "ci")))

```