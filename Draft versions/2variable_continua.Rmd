---
title: "Análisis de encuestas de hogares con R"
subtitle: "Módulo 1: Análisis de variables continuas"
author: |
  | Andrés Gutiérrez.
  | Stalyn Guerrero 
date: "CEPAL - Unidad de Estadísticas Sociales"
output:
  beamer_presentation:
    colortheme: dove
    fonttheme: default
    incremental: yes
    theme: Berkeley
    toc: yes
    slide_level: 2
    #highlight: pygments
  ioslides_presentation:
    incremental: yes
    widescreen: yes
    toc: yes
  slidy_presentation:
    incremental: yes
Email: andres.gutierrez@cepal.org
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, warning = FALSE, message = FALSE, error = FALSE)
options(digits = 4)
library (survey)
library(srvyr)
library(convey)
library(TeachingSampling)
library(printr)
```

# Motivación

Los desarrollos estadísticos están en permanente evolución, surgiendo nuevas metodologías y desarrollando nuevos enfoquen el análisis de encuestas. Estos desarrollos parten de la academia, luego son adoptados por las empresas (privadas o estatales) y entidades estatales. Las cuales crean la necesidad que estos desarrollos sean incluidos en software estadísticos licenciados. Proceso que puede llevar mucho tiempo.

## Motivación 

Algunos investigadores para acortar los tiempos y poner al servicio de la comunidad sus descubrimientos y desarrollos, hacen la implementasión de sus metodología en paquetes estadísticos de código abierto como **R** o **Python**. Teniendo **R** un mayor número de desarrollos en el procesamiento de las encuestas.

## Motivación 

Dentro del software *R* se disponen de múltiples librería para el prcesamiento de encuestas, estas varian dependiendo el enfoque de programación desarrollado por el autor o la necesidad que se busque suplir. En esta presentación nos centraremos en las libreria `survey` y `srvyr`. Se incluiran más librerías de acuerdo a las necesidad se presente. 


# Lectura y procesamientos de encuestas con `R`

## Lectura de la base

La base de datos (tablas de datos) puede estar disponible en una variedad de formatos (.`xlsx`, `.dat`, `.cvs`, `.sav`, `.txt`, ...), sin embargo, por experiencia es recomendable realizar la lectura de cualesquiera de estos formatos y proceder inmediatamente a guardarlo en un archivo de extensión **.rds**, la cual es nativa de `R.` El hacer esta acción reduce considerablemente los tiempo de cargue de la base de datos.

### Sintaxis

```{r}
encuesta <- readRDS("../Data/encuesta.rds")
```


## Definir diseño de la muestra con `srvyr`
La libreria `srvyr` surge como un complemento para `survey`. Estas librerías permiten definir objetos  tipo "**survey.design**" a los que se aplican los métodos "**survey.design**" complementados con la programación de tubería ( %>% ) del paquete `tidyverse`. 

## Cómo definir un objeto *survey.design*
Para el desarrollo  de la presentación se define el diseño muestral con la función `as_survey_design`. 
\scriptsize 
```{r}
# En caso de tener estratos con una muestra.
# Calcula la varianza centrada en la media de la pob.
options(survey.lonely.psu = "adjust") 
library(srvyr)

diseno <- encuesta %>% # Base de datos.
  as_survey_design(
    strata = Stratum,  # Id de los estratos.
    ids = PSU,         # Id para las observaciones.
    weights = wk,      # Factores de expansión. 
    nest = T           # Valida el anidado dentro 
                       #  del estrato
  )

```

# Análisis gráfico

## Histograma ponderado para la variable ingreso
A continuación observan la sintaxis para crear una histograma de la variable ingreso haciendo uso la función `svyhist` de la librería `survey`  


```{r, hist1, eval = FALSE}
svyhist(
  ~ Income ,
  diseno,
  main = "",
  col = "grey80",
  xlab = "Ingreso",
  probability = FALSE
)

```

## Histograma ponderado para la variable ingreso

```{r, hist1, echo = FALSE, eval = TRUE}
```

## Comparación de histogramas


```{r, hist2, eval=FALSE}
data("BigCity", package = "TeachingSampling")
par(mfrow = c(1,3))

svyhist(   ~ Income,
  diseno, main = "Ponderado",
  col = "green", breaks = 50
)
hist( encuesta$Income,
  main = "Sin ponderar",
  col = "red", prob = TRUE, breaks = 50
)
hist(  BigCity$Income,
  main = "Poblacional",
  col = "purple", prob = TRUE,
  xlim = c(0, 2500), breaks = 500
)

```

## Comparación de histogramas

```{r, hist2, echo = FALSE, eval = TRUE}
```

## Dividiendo la muestra en Sub-grupos

En ocasiones se desea realizar estimaciones por sub-grupos de la población, en este caso se extraer 4 sub-grupos de la encuesta.

```{r}
sub_Urbano <- diseno %>%  filter(Zone == "Urban")
sub_Rural  <- diseno %>%  filter(Zone == "Rural")
sub_Mujer  <- diseno %>%  filter(Sex == "Female")
sub_Hombre <- diseno %>%  filter(Sex == "Male")
```

## Histograma ponderado en sub-grupos
La sintaxis incluye un filtro de las personas mayores a 18 años

\scriptsize
```{r, hist3, eval=FALSE}
par(mfrow = c(1,2))
svyhist(
  ~ Income ,
  design = subset(sub_Mujer, Age >= 18),
  main = "Mujer",
  breaks = 30,
  col = "grey80",
  xlab = "Ingreso"
)

svyhist(
  ~ Income ,
  design = subset(sub_Hombre, Age >= 18),
  main = "Hombre",
  breaks = 30,
  col = "grey80",
  xlab = "Ingreso"
)

```

## Histograma ponderado en sub-grupos

```{r, hist3, echo = FALSE, eval = TRUE, out.width="80%", fig.align="center"}
```

Observe que hay una mayor proporción de hombres en el rango de los 1000 a 3000 que mujeres.

## Boxplot ponderado del ingreso por sub-grupos

```{r,box1, echo = TRUE, eval = FALSE}
par(mfrow = c(1,2))
svyboxplot(
  Income ~1 ,
  sub_Urbano,
  col = "grey80",
  ylab = "Ingreso",
  xlab = "Urbano")

svyboxplot(
  Income ~ 1 ,
  sub_Rural,
  col = "grey80",
  ylab = "Ingreso",
  xlab = "Rural"
)
```

## Boxplot ponderado del ingreso por sub-grupos

```{r,box1, echo = FALSE, eval = TRUE}
```

# Estimaciones puntuales. 

Después de realizar el análisis gráfico de las tendencias de las variables continuas, 
es necesarios obtener las estimaciones puntuales de la variables.  Los cuales son obtenidos 
de forma general o desagregado por niveles, de acuerdo con las necesidades de la investigación. 

## Estimación de totales e intervalos de confianza del ingreso
La estimación del total se mediante la función `svytotal` y el 
intervalos de confianza con la función `confint` de la librería `survey`.

```{r}
svytotal(~Income, diseno, deff=T) %>%
  data.frame()
confint(svytotal (~Income, diseno, deff=T))

```

## Estimación de totales e intervalos de confianza del gasto

```{r}
svytotal (~Expenditure, diseno, deff=T) %>% 
  data.frame()
confint(svytotal (~Expenditure, diseno, deff=T))

```

## Estimación de totales por sub-grupos

En esta oportunidad se hace uso de la función `cascade`de la libraría `srvyr`, la cual permite agregar
la suma de las categorías al final tabla. 
La función `group_by` permite obtener resultados agrupados por los niveles de interés. 

```{r}
diseno %>% group_by(Sex) %>%
  cascade(Total = survey_total(
    Income, level = 0.95,
    vartype =  c("se", "ci")),
          .fill = "Total ingreso")
```

## Estimación de la media e intervalo de confianza del ingreso

Un resultado más interesante para las variables ingreso y gasto es el promedio de la variable. 


```{r}
svymean(~Income, diseno, deff=T) %>% 
  data.frame()
confint(svymean (~Income, diseno, deff=T))
```

## Estimación de la media e intervalo de confianza del gasto


```{r}
svymean (~Expenditure, diseno, deff=T) %>% 
  data.frame()
confint(svymean (~Expenditure, diseno, deff=T))

```

## Estimación de la media por sub-grupos

La función `cascade` regresa el resultado promedio ignorando los niveles. 


```{r}
diseno %>% group_by(Sex) %>%
  cascade(
    Media = survey_mean(
      Expenditure, level = 0.95,
       vartype =  c("se", "ci")), 
        .fill = "El gasto medio"  ) %>%
  arrange(desc(Sex)) # Ordena la variable. 
```

## Estimación de la media por sub-grupos

```{r}
diseno %>% group_by(Zone) %>%
  cascade(
    Media = survey_mean(
      Expenditure, level = 0.95,
       vartype =  c("se", "ci")), 
        .fill = "El gasto medio")%>%
  arrange(desc(Zone))


```

## Estimación de medias por sub-grupos

\scriptsize


```{r}
diseno %>% group_by(Zone, Sex) %>%
  cascade(
    Media = survey_mean(
      Expenditure, level = 0.95,
       vartype =  c("se", "ci")),
        .fill = "El gasto medio") %>%
  arrange(desc(Zone), desc(Sex)) %>%
  data.frame()

```

## Estimación de la desviación estándar de los ingresos por sub-grupo

La estimación de la desviación estándar se obtiene con `survey_var` 

```{r}
(tab_sd <- diseno %>% group_by(Zone) %>% 
   summarise(Sd = sqrt(
  survey_var(
    Income,
    level = 0.95,
    vartype =  c("se", "ci"),
  ) )))
```

## Estimación de la desviación estándar de los ingresos por sub-grupo

```{r}
(tab_sd <- diseno %>% group_by(Zone, Sex) %>% 
   summarise(Sd = sqrt(
  survey_var(
    Income,
    level = 0.95,
    vartype =  c("se", "ci"),
   )
))) %>% data.frame()

```

## Estimación de la mediana para gastos

La estimación de la median se obtiene con `survey_median` 

```{r}
diseno %>% summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación de la mediana por sub-grupo

```{r}
diseno %>% group_by(Zone) %>% 
  summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación de la mediana por sub-grupo

```{r}
diseno %>% group_by(Sex) %>% 
  summarise(Mediana = 
  survey_median(
    Expenditure,
    level = 0.95,
    vartype =  c("se", "ci"),
   ))
```

## Estimación del quantil 0.5 para el gasto

La estimación de la median se obtiene con `survey_quantile`

```{r}
diseno %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.5,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación del quantil 0.25 para el gasto por sub-grupo

```{r}
diseno %>% group_by(Sex) %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.25,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación del quantile 0.25 para el gasto por sub-grupo

```{r}
diseno %>% group_by(Zone) %>% 
  summarise(
    Q =  survey_quantile(
    Expenditure,
    quantiles = 0.25,
    level = 0.95,
    vartype =  c("se", "ci"),
    interval_type = "score"
   ))
```

## Estimación de la razón entre el gasto y el ingreso
La estimación de una razón se obtiene con la función `survey_ratio`.  
```{r}
diseno %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón entre hombres y mujeres

```{r}
diseno %>% summarise(
    Razon =  survey_ratio(
      numerator = (Sex == "Female"),# creando dummy.
      denominator = (Sex == "Male"),# creando dummy.
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón entre hombres y mujeres en la zona rural

```{r}
sub_Rural %>% summarise(
    Razon =  survey_ratio(
      numerator = (Sex == "Female"),
      denominator = (Sex == "Male"),
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón del gastos y los ingreso entre las mujeres

```{r}
sub_Mujer %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

## Estimación de la razón del gasto y los ingresos entre los hombres

```{r}
sub_Hombre %>% summarise(
    Razon =  survey_ratio(
      numerator = Expenditure,
      denominator = Income,
      level = 0.95,
    vartype =  c("se", "ci")
    ))
```

# Índice de GINI
 Uno de los índices más utilizados en el estudio de la desigualdad es el Coeficiente de Concentración de Gini (CG). 
 El valor del índice de Gini se encuentra entre 0 y 1, siendo cero la máxima igualdad (todos los ciudadanos tienen los mismos ingresos) y 1 la máxima desigualdad (todos los ingresos los tiene un solo ciudadano). 
 
## Estimación del índice de GINI

La estimación del índice de GINI se realiza haciendo uso de la librería `convey`, para ello se procede así: 

```{r}
library(convey)
## Definir el diseño  
diseno_gini <- convey_prep(diseno)
## Calculo del indice para el ingreso
svygini( ~Income, design = diseno_gini) %>%
  data.frame()
```


## Estimación del índice de GINI

En forma análoga es posible obtener el indice de GINI para el gasto. 

```{r}
svygini( ~Expenditure, design = diseno_gini) %>%
  data.frame()

```

## Estimación del curva de Lorenz.
La **curva de Lorenz** es una representación gráfica de la desigualdad en la distribución de la renta, para obtener la representación gráfica de está usamos la función `svylorenz`.

```{r, out.width="70%", fig.align="center"}
svylorenz( ~Income, diseno_gini, 
           seq(0,1,.05), alpha = .01 )

```

# Pruebas de diferencia medias 
Los analistas de los datos de las encuestas suelen estar interesados en hacer inferencias sobre las diferencias de las estadísticas descriptivas de dos subpoblaciones. A continuación se muestra como realizar estas comparaciones haciendo uso de la función `svyttest`

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres
La comparación de los ingresos medios entre hombre y mujeres de la muestra se realiza así: 
```{r, test1, eval=FALSE}
svyttest(Income ~ Sex, diseno)
```

\scriptsize

```{r, test1, eval=TRUE, echo=FALSE}
```

\normalsize

El resultando indica que no hay diferencia entre los ingreso medios. 

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres en la zona urbana
También es posible realizar el procedimiento en sub-grupos de interés.  

```{r, test2, eval=FALSE}
svyttest(Income ~ Sex, sub_Urbano)
```

\scriptsize
```{r, test2, eval=TRUE, echo=FALSE}
```

\normalsize

El resultando indica que no hay diferencia entre los ingreso medios.

## Pruebas de diferencia medias de los ingresos entre hombres y mujeres mayores a 18 años

```{r, test3, eval=FALSE}
svyttest(Income ~ Sex, diseno %>% filter(Age > 18))
```

\scriptsize
```{r, test3, eval=TRUE, echo=FALSE}
```


## Contrastes
Ahora, el interés es realizar contrastes entre más de dos subpobaciones, por ejemplo por regiones geográficas.  

```{r, echo=FALSE}
(prom_region <- svyby(~Income, ~Region, diseno, 
                      svymean, na.rm=T, 
                      covmat = TRUE,
                      vartype = c("se", "ci")))
```
Por ejemplo, la diferencia media entre las regiones Norte y Sur $\hat{\bar{y}}_{Norte} - \hat{\bar{y}}_{Sur}$ 

## Procedimiento para realizar los contrastes 

```{r}
# Paso 1: diferencia de estimaciones (Norte - Sur) 
552.4 - 625.8
```

```{r,contr1_var,eval=FALSE}
# Paso 2: error estándar de la diferencia
vcov(prom_region)
```
\tiny
```{r,contr1_var,echo=FALSE,eval=TRUE}
```
\normalsize
```{r}
sqrt(3065 + 3894 - 2*0)
```

## Procedimiento para realizar los contrastes 
El procedimiento anterior se reduce a la sintaxis: 
```{r}
svycontrast(prom_region,
            list(diff_NS = c(1, -1, 0, 0, 0))) %>%
  data.frame()

```

## Creado una matriz de contrastes

Ahora el interés es realizar los contrastes siguientes: 

-   $\hat{\bar{y}}_{Norte} - \times\hat{\bar{y}}_{Centro}$, 
-   $\hat{\bar{y}}_{Sur}-\hat{\bar{y}}_{Centro}$ 	
-   $\hat{\bar{y}}_{Occidente}-\hat{\bar{y}}_{Oriente}$	

Escrita de forma matricial es: 

$$
\left[\begin{array}{ccccc}
1 & 0 & -1 & 0 & 0\\
0 & 1 & -1 & 0 & 0\\
0 & 0 & 0 & 1 & -1
\end{array}\right]
$$

## Creado una matriz de contrastes en `R`

\scriptsize

```{r}

svycontrast(prom_region, list(
           Norte_sur = c(1, 0, -1, 0, 0),
          Sur_centro = c(0, 1, -1, 0, 0),
   Occidente_Oriente = c(0, 0, 0, 1, -1)
            )) %>% data.frame()

sqrt(3065 + 3778 - 2*0) ; sqrt(3894 + 3778 - 2*0);
sqrt(2136 + 5136 - 2*0)

```

## Contrastes no independiente
Es posible que las variables estén correlacionadas.Por ejemplo, Ingreso y Sexo.

```{r}
(prom_sexo <-
   svyby(~Income, ~Sex, diseno,
         svymean, na.rm=T,covmat = TRUE,
         vartype = c("se", "ci")))


```

## Contrastes no independiente
El contraste 
$$
\hat{\bar{y}}_{F} - \hat{\bar{y}}_{M} 
$$
Es calculado como sigue: 

```{r}
svycontrast(prom_sexo, 
            list(diff_Sexo = c(1, -1))) %>% 
  data.frame()
```

## Contrastes no independiente

```{r}
vcov(prom_sexo)
# Note que el error estándar de la diff  es igual a 
sqrt(667.2 + 1196.3 - 2*716.3)
```

## Contrastes no independiente
Otra posibilidad es poder obtener resultados agregados, por ejemplo: 

$$
\hat{\bar{y}}_{Norte}+\hat{\bar{y}}_{Sur} +\hat{\bar{y}}_{Centro}
$$
\scriptsize
```{r}
(sum_region <- svyby( ~ Income,  ~ Region,
                     diseno, svytotal, na.rm = T,
                     covmat = TRUE,
                     vartype = c("se", "ci")))

```

## Contrastes no independiente
La matriz de contraste queda como: 
$$
\left[\begin{array}{cccccc}
1 & 1 & 1 & 0 & 0
\end{array}\right]
$$
el procedimiento en R es:

```{r}
svycontrast(sum_region,
            list(
              Agregado_NCS = c(1, 1, 1, 0, 0)
              )) %>% data.frame()


```

## Contrastes

```{r, c1, echo=TRUE, eval=FALSE}
require(kableExtra)
# Note que el error estándar  de la dif. es igual a 
vcov(sum_region) %>% data.frame() %>% 
  kable(digits = 10,
        format.args = list(scientific = FALSE))
```
\tiny
```{r, c1, echo=FALSE, eval=TRUE}
```
\normalsize

```{r}
sqrt(2272782099289 + 3526843231468 + 5681340267222 )
```

## Contrastes no independiente

La función puede usarse para obtener los promedios por categorías. Por ejemplo: 
$$
\hat{\bar{y}}_{Edad} = \frac{1}{k}\sum_{k=1}^K\hat{\bar{y}}_{k}
$$
donde $K$ es el número de categorías de la variable.

## Contrastes no independiente

```{r}
(prom_edad <- svyby(~Income, ~CatAge, diseno,
                    svymean, na.rm=T,covmat = TRUE))
```


## Contrastes no independiente
La matriz de contraste estaría dada por:
$$
\left[\begin{array}{cccccc}
\frac{1}{6} & \frac{1}{6} & \frac{1}{6} & \frac{1}{6} & \frac{1}{6} & \frac{1}{6}
\end{array}\right]
$$
El procedimiento en R es: 

```{r}
svycontrast(prom_edad,
  list(
  agregado_edad = c(1/6, 1/6, 1/6, 1/6, 1/6, 1/6)
      )) %>% data.frame()

```

## Contrastes no independiente

\scriptsize

```{r}
vcov(prom_edad)
```

\normalsize

```{r}
(1 / 6)*sqrt(
  833.4 + 1216.6 + 1399.9 + 726.2 + 3477.7 + 973.9 +
    2*548.4 + 2*361.1  + 2*262.3 + 2*132.7 + 2*312.6 +
    2*739.7 + 2*528.1  + 2*565.5 + 2*120.1 +
    2*534.9 + 2*1564.6 + 2*412.5 + 
    2*642.3 + 2*161.5  + 
    2*416.6)
```

## Contrastes no independiente

```{r,c2, echo=TRUE, eval=FALSE}
(razon_sexo <- svyby(~Income, ~Sex,
                     denominator = ~Expenditure,
                     diseno, svyratio, 
                     na.rm=T, covmat = TRUE, 
                     vartype = c("se", "ci")))
```

\tiny

```{r,c2, echo=FALSE, eval=TRUE}
```

## Contrastes no independiente

```{r}
svycontrast(razon_sexo,
            list(
              diff_sexo = c(1, -1)
              )) %>% data.frame()

```

## Contrastes no independiente

```{r}

vcov(razon_sexo)
sqrt(0.0021 + 0.0050 - 2*0.0027)

```

## ¡Gracias!

::: yellow
*Email*: [andres.gutierrez\@cepal.org](mailto:andres.gutierrez@cepal.org){.email}
:::
