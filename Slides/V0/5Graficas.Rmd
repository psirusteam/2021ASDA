---
title: "Análisis de encuestas de hogares con R"
subtitle: "Módulo 5: Análisis gráfico en R"
author: ""
date: "CEPAL - Unidad de Estadísticas Sociales"
output:
  beamer_presentation:
    colortheme: dove
    fonttheme: default
    incremental: yes
    theme: Berkeley
    toc: yes
    slide_level: 2
    #highlight: pygments
  ioslides_presentation:
    incremental: yes
    widescreen: yes
    toc: yes
  slidy_presentation:
    incremental: yes
Email: andres.gutierrez@cepal.org
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, error = FALSE)
options(digits = 4)
library(survey)
library(srvyr)
library(convey)
library(TeachingSampling)
library(printr)
```

## Lectura de la base

```{r}
data(BigCity, package = "TeachingSampling")
encuesta <- readRDS("../Data/encuesta.rds")
```

## Definir diseño de la muestra con `srvyr`
Definiendo el diseño muestral, esto se hace de forma análoga a la anterio. 
\scriptsize
```{r}
library(srvyr)
diseno <- encuesta %>%
  as_survey_design(
    strata = Stratum,
    ids = PSU,
    weights = wk,
    nest = T
  )
```

## Definir nuevas variables
Creando nuevas variales, para ello se hace uso de la función `mutate`.
\scriptsize
```{r, tabs1, echo=TRUE, eval=TRUE}
diseno <- diseno %>% mutate(
  pobreza = ifelse(Poverty != "NotPoor", 1, 0),
  desempleo = ifelse(Employment == "Unemployed", 1, 0),
  edad_18 = case_when(
    Age < 18 ~ "< 18 años",
    TRUE ~ ">= 18 años"
  )
)
```


## Sub-grupos

Dividiendo la muestra en sub grupos. 

```{r}
sub_Urbano <- diseno %>% filter(Zone == "Urban")
sub_Rural <- diseno %>% filter(Zone == "Rural")
sub_Mujer <- diseno %>% filter(Sex == "Female")
sub_Hombre <- diseno %>% filter(Sex == "Male")
```

## Creando tema para las gráficas 
Para tener un estilo estandar las gráficas se define el siguiente tema. 
```{r}
theme_cepal <- function(...) {
  theme_light(10) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      legend.position = "bottom",
      legend.justification = "left",
      legend.direction = "horizontal",
      plot.title = element_text(size = 20, hjust = 0.5),
      ...
    )
}
```


# Gráficas de variables continuas. 

## Histogramas 
Las gráficas son realizadas principalmente con la librería `ggplot2`y nos apoyamos en la librería `patchwork` para organizar la visual la visual de las gráficas. 

```{r, hist1, echo = TRUE, eval = TRUE}
library(ggplot2)
library(patchwork)
plot1_Ponde <- ggplot(
  data = encuesta,              # Fuente de datos.
  aes(x = Income, weight = wk)  # Parámetros gráficos general. 
) +
  geom_histogram(               # Parámetro geométrico.
    aes(y = ..density..)) +     # Parámetros del gráfico    
  ylab("") +                    # Nombre para el eje Y
  ggtitle("Ponderado") +        # Titulo. 
  theme_cepal()                 # Aplicando tema
```

## Histogramas 
De forma análoga se define el gráfico siguiente, note que en este caso se omitió el parámetro `weight`.  
```{r, hist1a, echo = TRUE, eval = TRUE}
plot1_SinPonde <-
  ggplot(encuesta, aes(x = Income)) +
  geom_histogram(aes(y = ..density..)) +
  ylab("") +
  ggtitle("Sin ponderar") +
  theme_cepal()
```

## Histogramas 
Para el siguiente dato se tomó la base poblacional (BigCity).  

```{r, hist1b, echo = TRUE, eval = FALSE}
plot1_censo <- ggplot(BigCity, aes(x = Income)) +
  geom_histogram(aes(y = ..density..)) +
  ylab("") +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 2500)
# Organizando la salida gráfica
plot1_censo | plot1_Ponde | plot1_SinPonde
```

## Histograma 
```{r, hist1b, echo = FALSE, eval = TRUE}
```


## Histogramas 
Ahora, repetimos la secuencia de gráficos para la variable *Expenditure*
```{r, hist2, echo = TRUE, eval = TRUE}
plot2_Ponde <- ggplot(
  data =  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_histogram(aes(y = ..density..)) +
  ylab("") +
  ggtitle("Ponderado") +
  theme_cepal()
```

## Histogramas 
\scriptsize
```{r, hist2a, echo = TRUE, eval = TRUE}
plot2_SinPonde <- ggplot(data = encuesta,
      aes(x = Expenditure)) +
      geom_histogram(aes(y = ..density..)) +
      ylab("") +
      ggtitle("Sin ponderar") +
      theme_cepal()
```

## Histogramas 
\scriptsize
```{r, hist2b, echo = TRUE, eval = FALSE}
plot2_censo <- ggplot(BigCity, aes(x = Expenditure)) +
  geom_histogram(aes(y = ..density..)) +
  ylab("") +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 1500)

plot2_censo | plot2_Ponde | plot2_SinPonde
```

## Histogramas

```{r, hist2b, echo = FALSE, eval = TRUE}
```

## Histogramas por sub-grupos
Cuando el interés es realizar comparaciones entre dos o más agrupaciones, es posible hacer uso del parámetro `fill`, el cual "rellena" las barras del histograma con diferentes colores según sea el grupo.   

\scriptsize
```{r, hist3, echo = TRUE, eval = TRUE}
plot3_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_histogram(
    aes(y = ..density.., fill = Zone),
    alpha = 0.5,
    position = "identity" # Para que las barras no estén apiladas.
  ) +
  ylab("") +
  ggtitle("Ponderado") +
  theme_cepal()
```

## Histogramas por sub-grupos
La sintaxis es homologa a la anterior, sin embargo, se retiro el parámetro `weight`.
```{r, hist3a, echo = TRUE, eval = TRUE}
plot3_SinPonde <- ggplot(encuesta, aes(x = Income)) +
  geom_histogram(aes(y = ..density.., fill = Zone),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Sin ponderar") +
  theme_cepal() +
  ylab("")
```

## Histogramas por sub-grupos
```{r, hist3b, echo = TRUE, eval = FALSE}
plot3_censo <- ggplot(BigCity, aes(x = Income)) +
  geom_histogram(aes(y = ..density.., fill = Zone),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 1500) +
  ylab("")
plot3_censo | plot3_Ponde | plot3_SinPonde
```

## Histogramas por sub-grupos

```{r, hist3b, echo = FALSE, eval = TRUE}
```


## Histogramas por sub-grupos
Ahora, repetimos la secuencia de gráficos para la variable *Expenditure*
```{r, hist4, echo = TRUE, eval = TRUE}
plot4_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_histogram(aes(y = ..density.., fill = Zone),
    alpha = 0.5, position = "identity"
  ) +
  ylab("") +
  ggtitle("Ponderado") +
  theme_cepal()
```

## Histogramas por sub-grupos
```{r, hist4a, echo = TRUE, eval = TRUE}
plot4_SinPonde <- ggplot(
  encuesta,
  aes(x = Expenditure)
) +
  geom_histogram(aes(y = ..density.., fill = Zone),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Sin ponderar") +
  theme_cepal() +
  ylab("")
```

## Histogramas por sub-grupos
```{r, hist4b, echo = TRUE, eval = FALSE}
plot4_censo <- ggplot(BigCity, aes(x = Expenditure)) +
  geom_histogram(aes(y = ..density.., fill = Zone),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 1500) +
  ylab("")
plot4_censo | plot4_Ponde | plot4_SinPonde
```

## Histogramas por sub-grupos

```{r, hist4b, echo = FALSE, eval = TRUE}
```

## Histogramas por sub-grupos
Ahora, repetimos la secuencia de gráficos para la variable *Income*, pero haremos el relleno por la variable *sexo*. 
```{r, hist5, echo = TRUE, eval = TRUE}
plot5_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ylab("") +
  ggtitle("Ponderado") +
  theme_cepal()
```

## Histogramas por sub-grupos
```{r, hist5a, echo = TRUE, eval = TRUE}
plot5_SinPonde <- ggplot(encuesta, aes(x = Income)) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Sin ponderar") +
  theme_cepal() +
  ylab("")
```

## Histogramas por sub-grupos
```{r, hist5b, echo = TRUE, eval = FALSE}
plot5_censo <- ggplot(BigCity, aes(x = Income)) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 1500) +
  ylab("")
plot5_censo | plot5_Ponde | plot5_SinPonde
```

## Histogramas por sub-grupos

```{r, hist5b, echo = FALSE, eval = TRUE}
```


## Histogramas por sub-grupos
Ahora, repetimos la secuencia de gráficos para la variable *Expenditure* y el relleno por la variable *sexo*. 

```{r, hist6, echo = TRUE, eval = TRUE}
plot6_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ylab("") +
  ggtitle("Ponderado") +
  theme_cepal()
```

## Histogramas por sub-grupos
\scriptsize
```{r, hist6a, echo = TRUE, eval = TRUE}
plot6_SinPonde <- ggplot(encuesta, aes(x = Expenditure)) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Sin ponderar") +
  theme_cepal() +
  ylab("")
```
\scriptsize

```{r, hist6b, echo = TRUE, eval = FALSE}
plot6_censo <- ggplot(BigCity, aes(x = Expenditure)) +
  geom_histogram(aes(y = ..density.., fill = Sex),
    alpha = 0.5, position = "identity"
  ) +
  ggtitle("Poblacional") +
  theme_cepal() +
  xlim(0, 1500) +
  ylab("")
plot6_censo | plot6_Ponde | plot6_SinPonde
```

## Histogramas por sub-grupos

```{r, hist6b, echo = FALSE, eval = TRUE}
```

## Agregando densidad
Dadas las cualidades de la librería ggplot2, podemos agregar nuevas capas a la gráfica. Por ejemplo, la densidad con la función `geom_density` e incorporamos el parámetro `alpha` que regula la transparencia del relleno. 
\scriptsize
```{r, out.width="60%", fig.align="center"}
plot1_Ponde + geom_density(fill = "blue", alpha = 0.3) |
  plot2_Ponde + geom_density(fill = "blue", alpha = 0.3)
```

## Agregando densidad
\scriptsize
Al hacer `aes(fill = Zone)` permite que la densidad sea agregada para cada una de las agrupaciones.
```{r,out.width="60%", fig.align="center"}
plot3_Ponde + geom_density(aes(fill = Zone), alpha = 0.3) |
  plot4_Ponde + geom_density(aes(fill = Zone), alpha = 0.3)
```


## Agregando densidad
En está oportunidad se agrega la desnidad por sexo
\scriptsize
```{r}
plot5_Ponde + geom_density(aes(fill = Sex), alpha = 0.3) |
  plot6_Ponde + geom_density(aes(fill = Sex), alpha = 0.3)
```

## Boxplot 
Otro gráfico que podemos hacer son los diagrames de caja, para esto deben emplear la función `geom_boxplot`.
\scriptsize
```{r, hist7, echo = TRUE, eval = FALSE}
plot7_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_boxplot() +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot8_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_boxplot() +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot7_Ponde | plot8_Ponde
```

## Boxplot 

```{r, hist7, echo = FALSE, eval = TRUE}
```


## Boxplot 
Esto diagramas también permiten la comparación  entre dos o más niveles de agrupamiento.  
\scriptsize
```{r, hist8, echo = TRUE, eval = FALSE}
plot9_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_boxplot(aes(fill = Zone)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot10_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_boxplot(aes(fill = Zone)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot9_Ponde | plot10_Ponde
```

## Boxplot 

```{r, hist8, echo = FALSE, eval = TRUE}
```

## Boxplot 
Ahora, si desean personalizar los colores del relleno debe hacer uso de la función `scale_fill_manual`. 
\scriptsize
```{r, echo = TRUE, eval = TRUE, out.width="60%", fig.align="center"}
colorZona <- c(Urban = "#48C9B0", Rural = "#117864")
plot9_Ponde + scale_fill_manual(values = colorZona) |
  plot10_Ponde + scale_fill_manual(values = colorZona)
```

## Boxplot 
Comparando los ingresos y gastos por sexo. 
\scriptsize
```{r, hist9, echo = TRUE, eval = FALSE}
plot11_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot12_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot11_Ponde | plot12_Ponde
```

## Boxplot 

```{r, hist9, echo = FALSE, eval = TRUE}
```

## Boxplot 
Definiendo el color del relleno para hombres y mujeres. 
\scriptsize
```{r, hist9a, echo = TRUE, eval = FALSE}
colorSex <- c(Male = "#5DADE2", Female = "#2874A6")
plot11_Ponde + scale_fill_manual(values = colorSex) |
  plot12_Ponde + scale_fill_manual(values = colorSex)
```

## Boxplot 
\scriptsize
```{r, hist9a, echo = FALSE, eval = TRUE}
```


## Boxplot 
Realizando la comparación para más de dos categorías. 
\scriptsize
```{r, hist10, echo = TRUE, eval = FALSE}
plot13_Ponde <- ggplot(
  encuesta,
  aes(x = Income, weight = wk)
) +
  geom_boxplot(aes(fill = Region)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot14_Ponde <- ggplot(
  encuesta,
  aes(x = Expenditure, weight = wk)
) +
  geom_boxplot(aes(fill = Region)) +
  ggtitle("Ponderado") +
  coord_flip() +
  theme_cepal()

plot13_Ponde | plot14_Ponde
```

## Boxplot 

```{r, hist10, echo = FALSE, eval = TRUE}
```

## Boxplot 
Personalizando los coles cuando hay más de  dos categorías. 
\scriptsize
```{r, plot13_Ponde, echo = TRUE, eval = FALSE}
colorRegion <- c(
  Norte = "#D6EAF8", Sur = "#85C1E9",
  Centro = "#3498DB", Occidente = "#2E86C1", Oriente = "#21618C"
)
plot13_Ponde + scale_fill_manual(values = colorRegion) |
plot14_Ponde + scale_fill_manual(values = colorRegion)
```
\scriptsize
```{r, plot13_Ponde, echo = FALSE, eval = TRUE, out.width="50%", fig.align="center"}
```



## Boxplot 
La función `geom_boxplot`permite realizar comparaciones con más de dos variables al tiempo. A continuación se compara los ingresos por sexo en las diferentes zonas.  

```{r, hist11, echo = TRUE, eval = TRUE}
plot15_Ponde <-
  ggplot(
    encuesta,
    aes(x = Income, y = Zone, weight = wk)
  ) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  scale_fill_manual(values = colorSex) +
  coord_flip()
```

## Boxplot 
De forma análoga podemos realizar la comparación de los gastos por sexo en las diferentes zonas.  
```{r, hist11a, echo = TRUE, eval = FALSE}
plot16_Ponde <-
  ggplot(
    encuesta,
    aes(x = Expenditure, y = Zone, weight = wk)
  ) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  scale_fill_manual(values = colorSex) +
  coord_flip()
plot15_Ponde / plot16_Ponde
```

## Boxplot 

```{r, hist11a, echo = FALSE, eval = TRUE}
```


## Boxplot 
Podemos extender las comparaciones variables que tienen más de dos categorías.  
```{r, hist12, echo = TRUE, eval = TRUE}
plot17_Ponde <-
  ggplot(
    encuesta,
    aes(x = Income, y = Region, weight = wk)
  ) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  scale_fill_manual(values = colorSex) +
  coord_flip()
```

## Boxplot 
```{r, hist12a, echo = TRUE, eval = FALSE}
plot18_Ponde <-
  ggplot(
    encuesta,
    aes(
      x = Expenditure,
      y = Region, weight = wk
    )
  ) +
  geom_boxplot(aes(fill = Sex)) +
  ggtitle("Ponderado") +
  scale_fill_manual(values = colorSex) +
  coord_flip()

plot17_Ponde / plot18_Ponde
```

## Boxplot 

```{r, hist12a, echo = FALSE, eval = TRUE}
```


## Scaterplot  

Un gráfico de interés son los de puntos o Scaterplot, que nos ayudan a ver correlación entre las variables, para realizar este tipo de gráfico usamos la función `geom_point`   

```{r, hist13, echo = TRUE, eval = FALSE}
plot19_Ponde <-
  ggplot(
    encuesta,
    aes(
      y = Income,
      x = Expenditure,
      weight = wk
    )
  ) +
  geom_point() +
  theme_cepal()
plot19_Ponde
```

## Scaterplot  
Note, que este caso el parámetro `weight` no esta aportando información visual al gráfico.
```{r, hist13, echo = FALSE, eval = TRUE, out.width="40%"}
```

## Scaterplot  
El parámetro `weight` lo podemos usar controlar el tamaño de los puntos de esa forma tener un mejor panorama del comportamiento de la muestra. 
```{r, hist14, echo = TRUE, eval = FALSE}
plot20_Ponde <-
  ggplot(
    encuesta,
    aes(y = Income, x = Expenditure)
  ) +
  geom_point(aes(size = wk), alpha = 0.3) +
  theme_cepal()
plot20_Ponde
```

## Scaterplot  

```{r, hist14, echo = FALSE, eval = TRUE}
```

## Scaterplot  
Otra forma de usar la variable `wk`, es asignar la intensidad del color según el valor de la variable. 
```{r, hist15, echo = TRUE, eval = FALSE}
plot21_Ponde <-
  ggplot(
    encuesta,
    aes(y = Income, x = Expenditure)
  ) +
  geom_point(aes(col = wk), alpha = 0.3) +
  theme_cepal()
plot21_Ponde
```

## Scaterplot  

```{r, hist15, echo = FALSE, eval = TRUE}
```

## Scaterplot  
Podemos extender las bondades de los gráfico de `ggplot2` para obtener mayor información de las muestra. Por ejemplo, agrupar los datos por Zona, para lograr esto se introduce el parámetro `shape`.  

```{r, hist16, echo = TRUE, eval = FALSE}
plot22_Ponde <-
  ggplot(
    encuesta,
    aes(
      y = Income, x = Expenditure,
      shape = Zone) # Formas por zona
  ) + geom_point(aes(
    size = wk, color = Zone
  ), alpha = 0.3) +
  labs(size = "Peso") +
  scale_color_manual(values = colorZona) +
  theme_cepal()
plot22_Ponde
```

## Scaterplot  

```{r, hist16, echo = FALSE, eval = TRUE}
```

## Scaterplot  
De forma similar podemos obtener el resultado por sexo. 
\scriptsize
```{r, hist17, echo = TRUE, eval = FALSE}
plot23_Ponde <-
  ggplot(
    encuesta,
    aes(
      y = Income,
      x = Expenditure,
      shape = Sex
    )
  ) +
  geom_point(aes(
    size = wk,
    color = Sex
  ),
  alpha = 0.3
  ) +
  labs(size = "Peso") +
  scale_color_manual(values = colorSex) +
  theme_cepal()
plot23_Ponde
```

## Scaterplot  

```{r, hist17, echo = FALSE, eval = TRUE}
```

## Scaterplot  
Un resultado equivalente se obtiene por región. 
\scriptsize
```{r, hist18, echo = TRUE, eval = FALSE}
plot24_Ponde <-
  ggplot(
    encuesta,
    aes(
      y = Income,
      x = Expenditure,
      shape = Region
    )
  ) +
  geom_point(aes(
    size = wk,
    color = Region
  ),
  alpha = 0.3
  ) +
  labs(size = "Peso") +
  scale_color_manual(values = colorRegion) +
  theme_cepal()
plot24_Ponde
```

## Scaterplot  

```{r, hist18, echo = FALSE, eval = TRUE}
```

# Diagrama de barras para variables categoricas  

## Diagrama de barras
Para realizar estos gráfico un primer paso es realizar las estimaciones puntuales. 
```{r, hist19, echo = TRUE, eval = TRUE}
(tamano_zona <- diseno %>%
  group_by(Zone) %>%
  summarise(
    Nd = survey_total(vartype = c("se", "ci"))
  ))
```

## Diagrama de barras
\scriptsize
```{r, hist19a, echo = TRUE, eval = FALSE}
plot25_Ponde <- ggplot(
  data = tamano_zona, # fuente de los datos
  aes(
    x = Zone,         # Valores en el eje x
    y = Nd,           # Altura de la barras 
    ymax = Nd_upp,    # Limite superior del IC
    ymin = Nd_low,    # Limite inferior del IC
    fill = Zone       # Color del relleno
  )
) +
  geom_bar(
    stat = "identity",# Valor incluido en la tabla 
    position = "dodge") +
  geom_errorbar(      # Gráfica del IC.
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  theme_bw()
plot25_Ponde
```

## Diagrama de barras
```{r, hist19a, echo = FALSE, eval = TRUE}
```

## Diagrama de barras
Como se ha visto en los gráficos anteriores podemos extender a muchas categorías. 
```{r, hist20, echo = TRUE, eval = TRUE}
(tamano_pobreza <- diseno %>%
  group_by(Poverty) %>%
  summarise(
    Nd = survey_total(vartype = c("se", "ci"))
  ))
```

## Diagrama de barras
El gráfico se obtiene con una sintaxis homologa a la anterior. 
\scriptsize
```{r, hist20a, echo = TRUE, eval = FALSE}
plot26_Ponde <- ggplot(
  data = tamano_pobreza,
  aes(
    x = Poverty,
    y = Nd,
    ymax = Nd_upp,
    ymin = Nd_low,
    fill = Poverty
  )
) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  theme_bw()
plot26_Ponde
```

## Diagrama de barras
```{r, hist20a, echo = FALSE, eval = TRUE}
```

## Diagrama de barras

De forma similar a los gráficos de Caja es posible realizar comparaciones entre más dos variables. 

```{r, hist21, echo = TRUE, eval = TRUE}
tamano_ocupacion_pobreza <- diseno %>%
  group_by(desempleo, Poverty) %>%
  summarise(
    Nd = survey_total(vartype = c("se", "ci"))
  ) %>%   as.data.frame() %>% 
  mutate(
    desempleo = ifelse(is.na(desempleo),
                       "Ninos",desempleo))

```

## Diagrama de barras
El gráfico para la tabla anterior queda de la siguiente forma. 
\scriptsize
```{r, hist21a, echo = TRUE, eval = FALSE}
plot27_Ponde <-
  ggplot(
    data = tamano_ocupacion_pobreza,
    aes(
      x = Poverty,
      y = Nd,
      ymax = Nd_upp,
      ymin = Nd_low,
      fill = as.factor(desempleo)
    )
  ) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  theme_bw()
plot27_Ponde
```

## Diagrama de barras

```{r, hist21a, echo = FALSE, eval = TRUE}
```


## Diagrama de barras
En estos gráficos podemos presentar proporciones por variables. 
```{r, hist22, echo = TRUE, eval = TRUE}
(prop_ZonaH_Pobreza <- sub_Hombre %>%
  group_by(Zone, Poverty) %>%
  summarise(
    prop = survey_prop(
      vartype = c("se", "ci")
    )
  ) %>%
  data.frame())
```

## Diagrama de barras
Después de tener la tabla con los valores a presentar el gráfico se realiza con la siguiente sintaxis. 
```{r, hist22a, echo = TRUE, eval = FALSE}
plot28_Ponde <- ggplot(
  data = prop_ZonaH_Pobreza,
  aes(
    x = Poverty, y = prop,
    ymax = prop_upp, ymin = prop_low,
    fill = Zone
  )) + 
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(
    position = position_dodge(width = 0.9),
    width = 0.3
  ) + scale_fill_manual(values = colorZona) +
  theme_bw();plot28_Ponde
```

## Diagrama de barras

```{r, hist22a, echo = FALSE, eval = TRUE}
```


## Diagrama de barras
Proporción de hombres en condición de pobreza por región 
```{r, hist23, echo = TRUE, eval = TRUE}
prop_RegionH_Pobreza <- sub_Hombre %>%
  group_by(Region, pobreza) %>%
  summarise(
    prop = survey_prop(vartype = c("se", "ci"))
  ) %>%
  data.frame()
```

## Diagrama de barras

```{r, hist23a, echo = TRUE, eval = FALSE}
plot29_Ponde <- ggplot(
  data = prop_RegionH_Pobreza,
  aes(
    x = Region, y = prop,
    ymax = prop_upp, ymin = prop_low,
    fill = as.factor(pobreza)
  )
) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(
    position = position_dodge(width = 0.9),
    width = 0.3
  ) +
  theme_bw()
plot29_Ponde
```

## Diagrama de barras

```{r, hist23a, echo = FALSE, eval = TRUE}
```

# Creando mapas 

## Mapas con tmap.
Para realizar el mapa hay que contar con el archivo de *shepefile*
```{r, hist24, echo=FALSE, eval=FALSE}
temp <- "V:/DAT/SAECEPAL/Recursos/Análisis de Encuestas"
library(sf)
library(tmap)
shapeBigCity <- read_sf(paste0(temp, "/Data/shapeBigCity/BigCity.shp"))
tm_shape(shapeBigCity) +
  tm_polygons(col = "Region")
```

```{r, echo = TRUE, eval = FALSE}
library(sf)
library(tmap)
shapeBigCity <- read_sf("/Data/shapeBigCity/BigCity.shp")
```
La forma más simple de crear el mapa es con la sintaxis. 
```{r, echo = TRUE, eval = FALSE}
tm_shape(shapeBigCity) + # shepefile
  tm_polygons(col = "Region") # Variable de interés. 
```

## Mapas con tmap.
El mapa resultante es: 
```{r, hist24, echo = FALSE, eval = TRUE}
```

## Mapas con tmap.
\scriptsize
```{r, hist25, echo = TRUE, eval = FALSE}
brks <- c(0, .2, .4, .6, 0.8, 1)
shape_temp <- tm_shape(
  shapeBigCity %>%      # shapefile
    left_join(          # Agregando una variable
      prop_RegionH_Pobreza %>%
        filter(pobreza == 1), # Filtrando el nivel de interés. 
      by = "Region"
    )
)

shape_temp + tm_polygons(
  "prop",              # Nombre de la columna
  breaks = brks,       # Puntos de corte 
  title = "pobreza",   # Titilo del labels. 
  palette = "YlOrRd"   # Paleta y dirección de colores
) 
```

## Mapas con tmap.

```{r, hist25, echo = FALSE, eval = TRUE}
```

## Mapas con tmap.
\scriptsize
```{r, hist26, echo = TRUE, eval = FALSE}
(prom_region <- svyby(~Income, ~Region, diseno,
  svymean,
  na.rm = T, covmat = TRUE,
  vartype = c("cv")
))
brks <- c(0, 0.2, 1)
shape_temp <- tm_shape(
  shapeBigCity %>%
    left_join(
      prom_region,
      by = "Region"
    )
)

shape_temp + tm_polygons(
  "cv",
  breaks = brks,
  title = "cv",
  palette = c("#FFFFFF", "#000000"),
) + tm_layout(asp = 0)
```


## Mapas con tmap.

```{r, hist26, echo = FALSE, eval = TRUE}
```


## Mapas con tmap.
\scriptsize
```{r, hist27, echo = TRUE, eval = FALSE}
prom_region_Sex <- diseno %>%
  group_by(Region, Zone, Sex, pobreza) %>%
  summarise(prop = survey_mean(vartype = "cv")) %>%
  filter(pobreza == 1, Zone == "Rural", Sex == "Female")

shape_temp <- tm_shape(
  shapeBigCity %>%
    left_join(
      prom_region_Sex,
      by = "Region"
    )
)

shape_temp + tm_polygons(
  "prop",
  title = "Pobreza",
) + tm_layout(asp = 0)
```

## Mapas con tmap.

```{r, hist27, echo = FALSE, eval = TRUE}
```



## Mapas con tmap.

```{r, hist27, echo = FALSE, eval = TRUE}
```

## Mapas con tmap.

```{r, hist28, echo = TRUE, eval = FALSE}
shape_temp + tm_polygons(
  "prop_cv",
  title = "cv",
  palette = c("#FFFFFF", "#000000"),
  breaks = c(0, 0.2, 1)
) + tm_layout(asp = 0)
```




## Mapas con tmap.

```{r, hist28, echo = FALSE, eval = TRUE}
```

## Mapas con ggplot
\scriptsize
```{r,hist30, echo = TRUE, eval = TRUE}
library(biscale)
library(cowplot)
temp_shape <- shapeBigCity %>%
  left_join(
    prom_region_Sex,
    by = "Region"
  )
k <- 3
datos.RM.bi <- bi_class(temp_shape,
  y = prop, x = prop_cv, dim = k,
  style = "fisher"
)
map.RM <- ggplot() +
  geom_sf(
    data = datos.RM.bi,
    aes(fill = bi_class, geometry = geometry),
    colour = "white", size = 0.1
  ) +
  bi_scale_fill(pal = "GrPink", dim = k) +
  bi_theme() +
  theme(legend.position = "none")
```

## mapas con ggplot
\scriptsize
```{r,hist31, echo = TRUE, eval = FALSE}
# Crear la leyenda para el mapa
legend1 <- bi_legend(
  pal = "GrPink", dim = k,
  xlab = "Coeficiente de variaci<U+00F3>n",
  ylab = "Pobreza", size = 8
)

mapa1 <- ggdraw() +
  draw_plot(map.RM, 0, 0, 1, scale = 0.7) +
  draw_plot(legend1, 0.75, 0.4, 0.2, 0.2, scale = 1) +
  draw_text("Estimaciones directas de la pobreza en la mujer rural",
    vjust = -13, size = 18
  )

mapa1
```

## mapas con ggplot
```{r, hist31, echo = FALSE, eval = TRUE}
```


## ¡Gracias!

::: yellow
*Email*: [andres.gutierrez\@cepal.org](mailto:andres.gutierrez@cepal.org){.email}
:::
